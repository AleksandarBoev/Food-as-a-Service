<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Users</title>
    <th:block th:replace="../fragments/bootstrap4"></th:block>
</head>
<body>
<th:block th:replace="../fragments/header"></th:block>

<main>
    <input id="search-input" placeholder="Search..."/>
    <button id="search-button">Search</button>
    <table class="table table-striped">
        <thead>
        <tr>
            <th scope="col">Name</th>
            <th scope="col">Email</th>
            <th scope="col"></th>
            <th scope="col"></th>
            <th scope="col"></th>
        </tr>
        </thead>
        <tbody>
            <tr>
                <td class="name">George</td>
                <td class="email">111@abv.bg</td>
            </tr>

            <tr>
                <td class="name">Pesho</td>
                <td class="email">222@abv.bg</td>
            </tr>

            <tr>
                <td class="name">Gosho</td>
                <td class="email">333@abv.bg</td>
            </tr>

            <tr>
                <td class="name">Tosho</td>
                <td class="email">123@abv.bg</td>
            </tr>

            <tr>
                <td class="name">Petrakan</td>
                <td class="email">444@abv.bg</td>
            </tr>
        </tbody>
    </table>


    <div class="modal fade" id="modalForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <p id="form-title" style="font-size: 30px" class="modal-title w-100 font-weight-bold"></p>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body mx-3">

                    <div class="md-form mb-4">
                        <i class="fas fa-lock prefix grey-text"></i>
                        <input type="password" id="defaultForm-pass" class="form-control validate">
                        <label data-error="wrong" data-success="right" for="defaultForm-pass">Your password</label>
                    </div>

                </div>
                <div class="modal-footer d-flex justify-content-center">
                    <button data-toggle="modal" data-target="#modalForm" id="confirm-action" class="btn btn-danger">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

<th:block th:replace="../fragments/footer"></th:block>

<script>
    const formElements = {
        inputPassword: document.getElementById('defaultForm-pass'),
        buttonConfirm: document.getElementById('confirm-action'),
        paragraphFormTitle: document.getElementById('form-title'),
    };

    const actions = {
        makeManager: "Make manager",
        makeUser: "Make user",
        delete: "Delete",
    };

    const getUserData = tableRow => {
        return {
            userId: tableRow.getAttribute("userId"),
            userName: tableRow.getElementsByClassName('username')[0].textContent,
        }
    };

    let lastAction;
    let tableRowAction;
    let userId;
    let userData;

    document.getElementsByTagName('tbody')[0].addEventListener('click', ev => {
        const targetClassList = ev.target.classList;

        if (targetClassList.contains('btn-manager')
            || targetClassList.contains('btn-user')
            || targetClassList.contains('btn-delete')) {

            if (targetClassList.contains('btn-manager')) {
                lastAction = actions.makeManager;
            } else if (targetClassList.contains('btn-user')) {
                lastAction = actions.makeUser;
            } else if (targetClassList.contains('btn-delete')) {
                lastAction = actions.delete;
            }

            tableRowAction = ev.target.parentNode.parentNode;
            userData = getUserData(tableRowAction);
            formElements.paragraphFormTitle.textContent = `Perform action "${lastAction}" on user "${userData.userName}"`;
        }
    });

    document.getElementById('confirm-action').addEventListener('click', () => {
        const body = {
            password: formElements.inputPassword.value,
            action: lastAction,
            userId: userData.userId,
        };
        formElements.inputPassword.value = '';
        fetch('/admin/users', {
            method: 'post',
            headers: {
                Accept: "application/json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body)
        }).then(response => {
            if (response.status === 401) {
                alert("Wrong password!")
            } else if (response.status === 200) {
                alert("Action \"" + lastAction + "\" successful!");
                switch (lastAction) {
                    case actions.makeManager:
                        tableRowAction.getElementsByClassName('btn-manager')[0].disabled = true;
                        tableRowAction.getElementsByClassName('btn-user')[0].disabled = false;
                        break;

                    case actions.makeUser:
                        tableRowAction.getElementsByClassName('btn-manager')[0].disabled = false;
                        tableRowAction.getElementsByClassName('btn-user')[0].disabled = true;
                        break;

                    case actions.delete:
                        tableRowAction.remove();
                        break;
                }

            } else if (response.status === 409) {
                switch (lastAction) {
                    case actions.makeManager:
                        alert('User is already a manager!');
                        break;

                    case actions.makeUser:
                        alert('User is already a ... user!');
                        break;

                    case actions.delete:
                        alert('User has already been deleted!');
                        break;
                }
            }
        });
    });


    const searchButton = document.getElementById('search-button');
    const searchInput = document.getElementById('search-input');
    const allNamesTds = [...document.getElementsByClassName('name')];
    const allEmailsTds = [...document.getElementsByClassName('email')];

    const hideTr = td => {
        td.parentNode.style.display = 'none';
    };

    const showTr = td => {
        td.parentNode.style.display = 'block';
    };
    searchButton.addEventListener('click', () => {
            const word = searchInput.value.toLowerCase();
            console.log(allEmailsTds);
            console.log(allEmailsTds[0]);
            console.log(allEmailsTds[0].textContent);

            if (word === "") {
                allNamesTds.forEach(showTr);
            } else {
                for (let i = 0; i < allNamesTds.length; i += 1) {
                    if (allNamesTds[i].textContent.toLocaleLowerCase().includes(word)
                        || allEmailsTds[i].textContent.toLowerCase().includes(word)) {
                        showTr(allEmailsTds[i]);
                    } else {
                        hideTr(allEmailsTds[i]);
                    }
                }
            }
        }
    )
</script>
</body>
</html>